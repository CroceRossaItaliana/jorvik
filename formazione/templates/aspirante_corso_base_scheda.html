{% extends "aspirante_vuota.html" %}

{% load bootstrap3 %}
{% load static %}
{% load utils %}

{% block pagina_titolo %}
    {% block scheda_titolo %}{% endblock %}
    {{ corso.nome }} ({{ corso.sede.nome_completo }}) &mdash; Corso
{% endblock %}


{% block app_contenuto %}
    <style>
        .course__name-without-title-cri {font-weight: bold; font-size:22px; color: #3c763d;}
    </style>

    {% if corso.titolo_cri %}<h2 class="course__title-cri">{{ corso.titolo_cri|default:"" }}</h2>{% endif %}

    <h4 class="course__name {% if not corso.titolo_cri %}course__name-without-title-cri{%endif%}">{{ corso.nome }}</h4>

    <h4 class="allinea-centro">
        <i class="fa fa-fw fa-map-marker"></i> {% if corso.locazione %}<a href="{{ corso.url_mappa }}">{{ corso.locazione }}</a>{% else %} Posizione non impostata{% endif %} &mdash;
        <i class="fa fa-fw fa-info-circle"></i> {{ corso.get_stato_display }}
    </h4>

    <ul class="nav nav-tabs dynamic-tabs-links">
        {% if puo_modificare %}
            <li role="presentation"><a data-tab-id="#tabAttivazione" href="#" class="attivazione tabSelectorLink"><i class="fa fa-fw fa-calendar"></i> Attivazione</a></li>
        {% endif %}

        <li role="presentation"><a data-tab-id="#tabDettagliCorso" href="#" class="dettagli tabSelectorLink"><i class="fa fa-fw fa-info"></i> Dettagli corso ed iscrizione</a></li>

        {% if puo_modificare %}
            {% now "U" as today_ts %}
            <li role="presentation"><a data-tab-id="#tabLezioni" href="#" class="lezioni tabSelectorLink"><i class="fa fa-fw fa-calendar"></i> Lezioni</a></li>
            {% if today_ts >= corso.data_esame|date:"U" %}<li role="presentation"><a data-tab-id="#tabEsami" href="#" class="esami tabSelectorLink"><i class="fa fa-fw fa-file-excel-o"></i> Documentazione Esame</a></li>{% endif %}
        {% endif %}

        {% if corso.is_nuovo_corso and corso.concluso %}
            <li role="presentation"><a data-tab-id="#tabQuestionario" href="#" class="questionario tabSelectorLink"><i class="fa fa-fw fa-thumbs-up"></i> Questionario</a></li>
        {% endif %}
    </ul>

    <div class="dynamic-tabs">
        {% if puo_modificare %}
        <ul id="tabAttivazione" class="nav nav-tabs">
            <li role="presentation"><a href="{% url 'formazione:new_course' %}"><i class="fa fa-fw fa-info"></i> Nuovo</a></li>
            <li {% if request.path == corso.url_direttori %}class="active_link"{% endif %} role="presentation"><a href="{{ corso.url_direttori }}"><i class="fa fa-fw fa-group"></i> Direttori ({{ corso.deleghe.count }})</a></li>

            {% if corso.tipo == 'C1' %}
                <li role="presentation" {% if request.path == corso.url_estensioni %}class="active_link"{% endif %}><a href="{% url 'aspirante:estensioni_modifica' corso.pk %}"><i class="fa fa-fw fa-pencil"></i> Area geografica interessata</a></li>
            {% endif %}
        </ul>
        {% endif %}

        <ul id="tabDettagliCorso" class="nav nav-tabs">
            <li {% if request.path == corso.url %}class="active_link"{% endif %} role="presentation"><a href="{{ corso.url }}"><i class="fa fa-fw fa-info"></i> Informazioni</a></li>
            {% if puo_modificare %}
                <li {% if request.path == corso.url_modifica %}class="active_link"{% endif %} role="presentation"><a href="{{ corso.url_modifica }}"><i class="fa fa-fw fa-pencil"></i> Pubblicizza il corso</a></li>
                <li {% if request.path == corso.url_iscritti %}class="active_link"{% endif %} role="presentation">
                    <a href="{{ corso.url_iscritti }}"><i class="fa fa-fw fa-group"></i> Iscrizioni
                        <i class="fa fa-fw fa-check"></i> {{ corso.partecipazioni_confermate.count }}
                        <i class="fa fa-fw fa-clock-o"></i> {{ corso.numero_partecipazioni_in_attesa_e_inviti }}
                    </a>
                </li>

                <li {% if 'informa' in request.path %}class="active_link"{% endif %} role="presentation"><a href="{% url 'aspirante:informa' corso.pk %}"><i class="fa fa-fw fa-envelope"></i> Invia messaggio</a></li>
            {% endif %}
        </ul>

        {% if puo_modificare %}
            <ul id="tabLezioni" class="nav nav-tabs">
                 <li {% if corso.url_lezioni in request.path %}class="active_link"{% endif %} role="presentation"><a href="{{ corso.url_lezioni }}"><i class="fa fa-fw fa-calendar"></i> Lezioni</a></li>
                 <li role="presentation"><a href="{{ corso.url_firme }}"><i class="fa fa-fw fa-file-pdf-o"></i> Scarica foglio firme</a></li>
            </ul>

            <ul id="tabEsami" class="nav nav-tabs">
                 <li {% if corso.url_report in request.path %}class="active_link"{% endif %} role="presentation"><a href="{{ corso.url_report }}"><i class="fa fa-fw fa-file-excel-o"></i> Scarica report</a></li>
            </ul>
        {% endif %}

        <ul id="tabQuestionario" class="nav nav-tabs">
            <li role="presentation"><a href="{% url 'survey:course' corso.pk %}"><i class="fa fa-fw fa-thumbs-up"></i> Compila il Questionario di gradimento</a></li>
            {% if puo_modificare %}
                <li {% if 'questionnaire/send-to-participants' in request.path %}class="active_link"{% endif %} role="presentation"><a href="{% url 'courses:send_questionnaire_to_participants' corso.pk %}"><i class="fa fa-fw fa-thumbs-up"></i> Invia il Questionario di gradimento</a></li>
            {% endif %}
        </ul>
    </div>

    {% if puo_modificare and corso.stato == corso.PREPARAZIONE and corso.prossimo and not corso.is_nuovo_corso %}
        <div class="alert alert-danger">
            <h4><i class="fa fa-warning"></i> Non c'è tempo da perdere!</h4>
            <p>Questo corso inizier&agrave; a breve, ma non hai ancora attivato il Corso su Gaia.</p>
            <p>Questo vuol dire che il corso non pu&ograve; ancora essere raggiunto da
                <strong>nessuno dei {{ corso.aspiranti_nelle_vicinanze.count }} aspiranti</strong>
                che aspettano un corso nelle vicinanze su Gaia. Ti consigliamo di completare con
                quanti pi&ugrave; dettagli possibile la scheda
                di questo corso e procedere all'attivazione: raggiungerai cos&igrave; tutti
                gli aspiranti nelle vicinanze.</p>
        </div>
    {% endif %}

    {% if puo_modificare and corso.stato == corso.PREPARAZIONE and can_activate %}
        <div class="alert alert-warning alert-block">
            <h4><i class="fa fa-fw fa-warning"></i> Il corso non &egrave; ancora attivo</h4>
            <p>Questo corso &egrave; ancora una bozza ("In Preparazione").
                È necessario attivare il corso affinch&eacute; questo possa essere trovato {% if corso.is_nuovo_corso %}dai volontari{%else%}dagli aspiranti{%endif%}.
                Completa i passi necessari e clicca sul pulsante per attivare il corso:
            </p>

            <p>
                {% if corso.direttori_corso.count == 0 %}
                    <i class="fa fa-fw text-danger fa-square"></i> <span class="text-danger">DA FARE</span>:
                {% else %}
                    <i class="fa fa-fw text-success fa-check-square"></i> <span class="text-success">FATTO</span>:
                {% endif %}
                Selezionare almeno un direttore del Corso dalla scheda "Attivazione - Direttori"
            </p>

            {% if corso.is_nuovo_corso %}
                <p>
                    {% if corso.extension_type == corso.EXT_MIA_SEDE %}
                        <i class="fa fa-fw text-danger fa-square"></i> <span class="text-danger">DA FARE</span>:
                    {% else %}
                        <i class="fa fa-fw text-success fa-check-square"></i> <span class="text-success">FATTO</span>:
                    {% endif %}
                    Conferma l'estensione a chi vuoi aprire il Corso dalla scheda "Attivazione - Area geografica interessata"
                </p>
            {% endif %}

            <p>{% checkbox corso.descrizione %}: Inserisci una descrizione del Corso per i Corsisti dalla scheda "Dettagli - Pubblicizza corso"</p>
            <!--<p>{% checkbox corso.locazione %}: Inserisci l'indirizzo del Corso dalla scheda "Dettagli - Pubblicizza corso"</p>-->

            <p style="text-align: center;margin-top: 20px;">
                <a class="btn btn-warning {% if not corso.attivabile %}disabled{% endif %}" {% if corso.attivabile %}href="{{ corso.url_attiva }}"{% endif %}>
                    <i class="fa fa-fw fa-check-circle"></i>

                    {% if corso.is_nuovo_corso %}
                        {% if corso.extension_type == corso.EXT_MIA_SEDE %}
                            Attiva il corso e informa i volontari della mia sede
                        {% elif corso.extension_type == corso.EXT_LVL_REGIONALE %}
                            Attiva il corso e informa i volontari dei segmenti selezionati.
                        {% else %}
                            Attiva il corso
                        {% endif %}
                    {% else %}
                        Attiva il corso e informa gli aspiranti in zona (più di {{ corso.aspiranti_nelle_vicinanze.count }})
                    {% endif %}
                </a>
            </p>
        </div>
    {% endif %}

    {% if puo_modificare and corso.terminabile %}
        <div class="alert alert-success alert-block">
            <h4><i class="fa fa-fw fa-warning"></i> Terminazione corso</h4>
            <p>Il corso si &egrave; concluso, ma &egrave; ancora necessario generare il verbale del corso e compilare la relazione.</p>
            <p>Una volta generato il verbale e compilata la relazione, tutti i partecipanti verranno informati dell'esito e,
                coloro che saranno stati promossi, verranno trasformati automaticamente in volontari.</p>

            <table style="text-align:center; width:100%; margin-top:20px;">
                <tr>
                    <td><a class="btn btn-default" href="{{ corso.url_termina }}"><i class="fa fa-fw fa-check-circle"></i>
                Generare il verbale</a></td>
                    <td><a class="btn {% if corso.relazione_direttore.is_completed %}btn-success{%else%}btn-default{%endif%}" href="{% url 'courses:compila_relazione_direttore' corso.pk %}"><i class="fa fa-fw fa-pencil"></i>
                Inserire la relazione</a></td>
                    {% if corso.relazione_direttore and corso.relazione_direttore.is_completed %}
                    <td><a class="btn btn-danger" href="{{ corso.url_termina }}?terminate_course"><i class="fa fa-fw fa-times-circle"></i> Terminare il corso</a></td>
                    {% endif %}
                </tr>
            </table>
        </div>
    {% endif %}

    <p>&nbsp;</p>
    {% block scheda_contenuto %}{% endblock %}
    <p>&nbsp;</p>
    <hr />

    <div class="piu-piccolo allinea-centro"><i class="fa fa-fw fa-clock-o"></i> Ultimo aggiornamento {{ corso.ultima_modifica }}</div>

    <script>
        // Highlight active tab and nav-link after page reload
        var active_link_parent_tab = $('.dynamic-tabs ul li.active_link').parent();
        var data_tab_id = active_link_parent_tab.attr('id');
        active_link_parent_tab.addClass('displayed');
        $('a[data-tab-id="#' +data_tab_id+ '"]').parent().addClass('active');

        // Change tabs
        $('.tabSelectorLink').on('click', function(e) {
            e.preventDefault();

            // Hide previously active nav link
            $('.dynamic-tabs-links .active').removeClass('active');

            // Hide already displayed tab
            let displayed = $('.dynamic-tabs .displayed');
            if (displayed) {
                displayed.removeClass('displayed');
                displayed.hide();
            }

            // Highlight newly active nav link
            $(this).parent().addClass('active');

            // Show tab
            let tab_id = $(this).data('tab-id');
            $(tab_id).show();
            $(tab_id).addClass('displayed');
        });
    </script>
{% endblock %}
